rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Interactions collection: stores aggregated results
    match /interactions/{interactionId} {
      allow read: if true;
      
      // Strict update: must be authenticated, and total_votes must increment by exactly 1
      allow update: if request.auth != null 
                    && request.resource.data.total_votes == resource.data.total_votes + 1;
      
      // Allow initial creation (lazy initialization)
      allow create: if request.auth != null;
    }

    // User Votes collection: prevents double voting
    match /user_votes/{voteId} {
      // voteId is expected to be [userId]_[interactionId]
      
      // Allow creation only if the user is authenticated and the ID matches their UID
      allow create: if request.auth != null 
                    && voteId[0:request.auth.uid.size()] == request.auth.uid
                    && !exists(/databases/$(database)/documents/user_votes/$(voteId));
      
      allow read, update, delete: if false;
    }
  }
}
